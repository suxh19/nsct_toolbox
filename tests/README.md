# NSCT Toolbox æµ‹è¯•æ–‡æ¡£

## æ¦‚è¿°

æœ¬æµ‹è¯•å¥—ä»¶ç”¨äºéªŒè¯ `nsct_python/utils.py` å’Œ `nsct_torch/utils.py` ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚

## æµ‹è¯•å†…å®¹

æµ‹è¯•æ–‡ä»¶ `test_utils_consistency.py` éªŒè¯ä»¥ä¸‹å‡½æ•°åœ¨ NumPy å’Œ PyTorch å®ç°ä¹‹é—´çš„ä¸€è‡´æ€§ï¼š

### æµ‹è¯•çš„å‡½æ•°

1. **extend2** - 2D å›¾åƒæ‰©å±•
   - å‘¨æœŸæ‰©å±•æ¨¡å¼ (per)
   - è¡Œæ–¹å‘ quincunx æ‰©å±• (qper_row)
   - åˆ—æ–¹å‘ quincunx æ‰©å±• (qper_col)

2. **symext** - å¯¹ç§°æ‰©å±•
   - åŸºæœ¬å¯¹ç§°æ‰©å±•
   - ä¸åŒ shift å‚æ•°çš„æ‰©å±•

3. **upsample2df** - 2D æ»¤æ³¢å™¨ä¸Šé‡‡æ ·
   - power=1 ä¸Šé‡‡æ ·
   - power=2 ä¸Šé‡‡æ ·

4. **modulate2** - 2D è°ƒåˆ¶
   - both æ¨¡å¼
   - row æ¨¡å¼
   - col æ¨¡å¼

5. **resampz** - çŸ©é˜µé‡é‡‡æ ·ï¼ˆå‰ªåˆ‡ï¼‰
   - type 1: å‚ç›´å‰ªåˆ‡
   - type 2: å‚ç›´å‰ªåˆ‡
   - type 3: æ°´å¹³å‰ªåˆ‡
   - type 4: æ°´å¹³å‰ªåˆ‡

6. **qupz** - Quincunx ä¸Šé‡‡æ ·
   - type 1 ä¸Šé‡‡æ ·
   - type 2 ä¸Šé‡‡æ ·
   - æ›´å¤§çŸ©é˜µæµ‹è¯•

## éªŒè¯æŒ‡æ ‡

æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹éªŒè¯ä»¥ä¸‹å››ä¸ªæ–¹é¢çš„ä¸€è‡´æ€§ï¼š

1. **å½¢çŠ¶ä¸€è‡´æ€§** - è¾“å‡ºæ•°ç»„çš„å½¢çŠ¶å¿…é¡»å®Œå…¨ç›¸åŒ
2. **æ•°å€¼ä¸€è‡´æ€§** - æ•°å€¼è¯¯å·®å¿…é¡»åœ¨å®¹å·®èŒƒå›´å†…
   - ç›¸å¯¹å®¹å·® (rtol): 1e-6
   - ç»å¯¹å®¹å·® (atol): 1e-8
3. **ç²¾åº¦ä¸€è‡´æ€§** - æ•°æ®ç±»å‹å…¼å®¹æ€§æ£€æŸ¥
4. **é€å…ƒç´ ä¸€è‡´æ€§** - å¯¹åº”ä½ç½®çš„æ•°å€¼å¿…é¡»å®Œå…¨ä¸€è‡´

## è¿è¡Œæµ‹è¯•

### ä¸€è‡´æ€§æµ‹è¯•

æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶è¿è¡Œæ‰€æœ‰ä¸€è‡´æ€§æµ‹è¯•ï¼š

```powershell
.venv\Scripts\Activate.ps1
pytest tests/test_utils_consistency.py -v -s
```

### æ€§èƒ½æµ‹è¯•

è¿è¡Œæ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼ˆCPU vs GPUï¼‰ï¼š

```powershell
.venv\Scripts\Activate.ps1
pytest tests/test_performance.py -v -s
```

ğŸ“ **è¯¦ç»†æ€§èƒ½æµ‹è¯•æ–‡æ¡£**: è¯·æŸ¥çœ‹ [PERFORMANCE_TESTING.md](PERFORMANCE_TESTING.md)

### è¿è¡Œç‰¹å®šæµ‹è¯•

```powershell
# åªæµ‹è¯• extend2 å‡½æ•°
pytest tests/test_utils_consistency.py::TestUtilsConsistency::test_extend2_per_mode -v -s

# åªæµ‹è¯• qupz å‡½æ•°
pytest tests/test_utils_consistency.py -k "qupz" -v -s
```

### ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š

```powershell
# ç”Ÿæˆ HTML æŠ¥å‘Š
pytest tests/test_utils_consistency.py --html=report.html --self-contained-html

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/test_utils_consistency.py --cov=nsct_python --cov=nsct_torch
```

## æµ‹è¯•ç»“æœ

æ‰€æœ‰ 17 ä¸ªæµ‹è¯•ç”¨ä¾‹å‡å·²é€šè¿‡ï¼ŒéªŒè¯äº†ï¼š
- âœ… å½¢çŠ¶å®Œå…¨ä¸€è‡´
- âœ… æ•°å€¼è¯¯å·®ä¸º 0ï¼ˆå®Œç¾ä¸€è‡´ï¼‰
- âœ… æ•°æ®ç±»å‹å…¼å®¹
- âœ… å¯¹åº”ä½ç½®çš„æ•°å€¼å®Œå…¨ä¸€è‡´

## æµ‹è¯•è¾“å‡ºç¤ºä¾‹

### ç®€æ´æ¨¡å¼è¾“å‡º
```
æµ‹è¯• extend2 (per æ¨¡å¼):
  âœ“ å½¢çŠ¶ä¸€è‡´æ€§: (6, 6)
  âœ“ numpy dtype: float32, torch dtype: torch.float32
  âœ“ æœ€å¤§æ•°å€¼å·®å¼‚: 0.0

  ğŸ“Š NumPy è¾“å‡º:
  [[15. 12. 13. 14. 15. 12.]
   [ 3.  0.  1.  2.  3.  0.]
   [ 7.  4.  5.  6.  7.  4.]
   [11.  8.  9. 10. 11.  8.]
   [15. 12. 13. 14. 15. 12.]
   [ 3.  0.  1.  2.  3.  0.]]

  ğŸ“Š PyTorch è¾“å‡º:
  [[15. 12. 13. 14. 15. 12.]
   [ 3.  0.  1.  2.  3.  0.]
   [ 7.  4.  5.  6.  7.  4.]
   [11.  8.  9. 10. 11.  8.]
   [15. 12. 13. 14. 15. 12.]
   [ 3.  0.  1.  2.  3.  0.]]

  ğŸ” éšæœºæŠ½æ ·éªŒè¯ (10 ä¸ªä½ç½®):
     ä½ç½® [29]: numpy=12.00000000, torch=12.00000000 âœ“
     ä½ç½® [22]: numpy=11.00000000, torch=11.00000000 âœ“
     ä½ç½® [28]: numpy=15.00000000, torch=15.00000000 âœ“
     ... (å…¶ä½™ 5 ä¸ªä½ç½®å‡åŒ¹é…)
PASSED
```

### è¯¦ç»†è¾“å‡ºç‰¹æ€§

1. **å°æ•°ç»„ (â‰¤100 å…ƒç´ )**: å®Œæ•´æ˜¾ç¤º NumPy å’Œ PyTorch çš„è¾“å‡ºæ•°ç»„
2. **å¤§æ•°ç»„ (>100 å…ƒç´ )**: æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯å’Œå·¦ä¸Šè§’ 3x3 å­çŸ©é˜µ
3. **éšæœºæŠ½æ ·**: éšæœºé€‰æ‹© 10 ä¸ªä½ç½®ï¼Œé€ä¸ªéªŒè¯æ•°å€¼ä¸€è‡´æ€§
4. **å·®å¼‚çŸ©é˜µ**: å¦‚æœæœ‰å·®å¼‚ï¼Œä¼šæ˜¾ç¤ºå·®å¼‚çŸ©é˜µ

## é¡¹ç›®ç»“æ„

```
nsct_toolbox/
â”œâ”€â”€ nsct_python/
â”‚   â””â”€â”€ utils.py          # NumPy å®ç°
â”œâ”€â”€ nsct_torch/
â”‚   â””â”€â”€ utils.py          # PyTorch å®ç°
â””â”€â”€ tests/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ test_utils_consistency.py  # ä¸€è‡´æ€§æµ‹è¯•
    â””â”€â”€ README.md         # æœ¬æ–‡æ¡£
```

## ä¾èµ–é¡¹

- pytest
- numpy
- torch

## æ³¨æ„äº‹é¡¹

1. è¿è¡Œæµ‹è¯•å‰è¯·ç¡®ä¿å·²æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
2. æµ‹è¯•ä½¿ç”¨ float32 ç²¾åº¦è¿›è¡Œæ¯”è¾ƒ
3. modulate2 å‡½æ•°ä¼šè‡ªåŠ¨è½¬æ¢ä¸º float64 è¿›è¡Œè®¡ç®—
4. æ‰€æœ‰æµ‹è¯•éƒ½åœ¨ CPU ä¸Šè¿è¡Œ

## æ‰©å±•æµ‹è¯•

å¦‚éœ€æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¯·éµå¾ªä»¥ä¸‹æ¨¡å¼ï¼š

```python
def test_function_name(self, tolerance):
    """æµ‹è¯•æè¿°"""
    print("\næµ‹è¯•ä¿¡æ¯:")
    # åˆ›å»º numpy æ•°æ®
    x_np = ...
    # è½¬æ¢ä¸º torch
    x_torch = self.numpy_to_torch(x_np)
    
    # æ‰§è¡Œå‡½æ•°
    result_np = np_utils.function_name(x_np, ...)
    result_torch = torch_utils.function_name(x_torch, ...)
    
    # éªŒè¯ä¸€è‡´æ€§
    self.assert_arrays_equal(result_np, result_torch, tolerance)
```

## ç»´æŠ¤è€…

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ issue æˆ– pull requestã€‚
